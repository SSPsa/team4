<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.accp.routinglnspection.dao.PollingMissionDao">
    <resultMap id="queryPollingMissionMap" type="PollingMission">
        <result property="id" column="pid"/>
        <result property="pmName" column="pmName"/>
        <result property="pmNumber" column="pmNumber"/>
        <result property="cId" column="cId"/>
        <result property="releaseUid" column="releaseUid"/>
        <result property="pollingUid" column="pollingUid"/>
        <result property="pmRemark" column="pmRemark"/>
        <result property="releaseTime" column="releaseTime"/>
        <result property="accomplishTime" column="accomplishTime"/>
        <result property="pmState" column="pmState"/>
        <association property="circuit" javaType="Circuit">
            <result property="riseTid" column="riseTid"/>
            <result property="cName" column="cName"/>
            <result property="endTid" column="endTid"/>
        </association>
        <association property="release" javaType="User">
            <result property="uName" column="uName"/>
            <result property="uNumber" column="uNumber"/>
        </association>
        <association property="polling" javaType="User">
            <result property="uName" column="u1nam"/>
        </association>
    </resultMap>
    <select id="queryPollingMission" resultMap="queryPollingMissionMap">
        SELECT c.*,p.`id` pid,p.`pmName`,p.`accomplishTime`,p.`cId`,p.`pmNumber`,p.`pmRemark`,p.`pmState`,p.`pollingUid`,p.`releaseTime`,p.`releaseUid`,p.`state`,u.*,u1.`uName` u1nam
        <include refid="sql"/>
        limit #{begin} , #{pageSize}
    </select>

    <select id="queryPollingMissionInt" resultType="_int">
       SELECT COUNT(*)
        <include refid="sql"/>
    </select>

    <select id="queryCircuit" resultType="Circuit">
        SELECT * FROM `circuit`
        <where>
    <if test="id>0">and id=${id}</if>
</where>
</select>


    <select id="queryUser" resultType="User">
        SELECT * FROM USER WHERE rid=3 AND ustate=1
    </select>


    <sql id="sql">
        FROM `pollingmission` p LEFT  JOIN  `circuit` c ON c.`id`=p.`cId` LEFT  JOIN  `user` u ON p.`releaseUid`=u.`id` LEFT  JOIN  `user` u1 ON p.`pollingUid`=u1.`id`
        <where>
            <if test="pmName !=null and pmName!=''"> and p.pmName like concat('%',#{pmName},'%')</if>
            <if test="id >0"> and p.id=#{id}</if>
            <if test="pmNumber !=null and pmNumber!=''"> and p.pmNumber like concat('%',#{pmNumber},'%')</if>
            <if test="cId>0"> and p.cId=#{cId}</if>
            <if test="releaseUid>0"> and p.releaseUid=#{releaseUid}</if>
            <if test="pollingUid>0"> and p.pollingUid=#{pollingUid}</if>
            <if test="pmState>0"> and p.pmState=#{pmState}</if>
            <if test="pmRemark !=null and pmRemark!=''"> and p.pmRemark=#{pmRemark}</if>
            <if test="releaseTime !=null"> and p.releaseTime &gt;=#{releaseTime}</if>
            <if test="accomplishTime !=null"> and p.accomplishTime &lt;= #{releaseTime}</if>
            <if test="release !=null"> and u.uName like concat('%',#{release.uName},'%')</if>
            <if test="circuit !=null"> and c.cNumber=#{circuit.cNumber}</if>
        </where>
    </sql>


    <insert id="addPollingMission">
       insert  into `pollingmission`(`pmName`,`pmNumber`,`cId`,`releaseUid`,`pollingUid`,`pmRemark`,`releaseTime`,`accomplishTime`,`pmState`,`state`)
       values (#{pmName},#{pmNumber},#{cId},#{releaseUid},#{pollingUid},#{pmRemark},#{releaseTime},#{accomplishTime},#{pmState},#{state})
    </insert>

    <update id="updatePollingMission">
      UPDATE pollingmission
      <set>
          <if test="pmName !=null and pmName!=''">pmName=#{pmName},</if>
          <if test="pmNumber !=null and pmNumber!=''"> pmNumber=#{pmNumber},</if>
          <if test="cId>0">cId=#{cId},</if>
          <if test="releaseUid>0"> releaseUid=#{releaseUid},</if>
          <if test="pollingUid>0"> pollingUid=#{pollingUid},</if>
          <if test="pmState>0">pmState=#{pmState},</if>
          <if test="pmRemark !=null and pmRemark!=''">pmRemark=#{pmRemark},</if>
          <if test="releaseTime !=null">releaseTime=#{releaseTime},</if>
          <if test="accomplishTime !=null">accomplishTime=#{accomplishTime},</if>
          <if test="state>-1"> state=#{state},</if>
      </set>
        where id=#{id}
    </update>


    <delete id="deletePollingMission">
      DELETE FROM `pollingmission` WHERE id=#{id}
    </delete>
</mapper>